<!-- This is a static file -->
<!-- served from your routes in server.js -->

<!DOCTYPE html>
<html>
  <head>
    <title>It's Bird O'Clock!</title>
    <meta name="description" content="p5.js CDN Template" />
    <link
      href="https://unpkg.com/@pqina/flip/dist/flip.min.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/@pqina/flip/dist/flip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.3.0/lib/p5.js"></script>
    <!--script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.0/addons/p5.dom.js"></script-->
    <!--script src="/sketch.js"></script-->
  </head>
  <body>
    <style>
      .tick {
        font-size: 1rem;
        font-family: arial, sans-serif;
        margin:10em;
      }

      .tick-flip,
      .tick-text-inline {
        font-size: 2.5em;
      }

      .tick-label {
        margin-top: 1em;
        font-size: 1em;
      }

      .tick-char {
        width: 1.5em;
      }

      .tick-text-inline {
        display: inline-block;
        text-align: center;
        min-width: 1em;
        
      }

      .tick-text-inline + .tick-text-inline {
        margin-left: -0.325em;
      }

      .tick-group {
        margin: 0 0.5em;
        text-align: center;
      }

      body {
        background-color: rgb(255, 255, 255) !important;
      }

      .tick-text-inline {
        color: rgb(90, 93, 99) !important;
      }

      .tick-label {
        color: rgb(90, 93, 99) !important;
      }

      .tick-flip-panel {
        color: rgb(255, 255, 255) !important;
      }

      .tick-flip {
        font-family: !important;
      }

      .tick-flip-panel-text-wrapper {
        line-height: 1.5 !important;
      }

      .tick-flip-panel {
        background-color: rgb(159, 61, 59) !important;
      }

      .tick-flip-panel-front {
        background-size: cover;
      }

      .tick-flip {
        border-radius: 0.05em !important;
        height: 3em;
      }
      
      .species {
        margin-right:0.25em;
        margin-left:0.25em;
        margin-top:1em;
        margin-left:-0.5em;
        white-space: normal;
        font-size:0.2em !important;
        letter-spacing:0em !important;
        color:white;
      }
    </style>

    <div class="tick" data-did-init="handleTickInit">
      <div data-layout="horizontal fit">
        <span
          id="hours"
          data-key="hours"
          data-view="flip"
        ></span>


        <span
          id="mins"
          data-key="minutes"
          data-view="flip"
        ></span>

        <div class="secs">

          <span
            id="secs"
            data-key="seconds"
            data-view="flip"
          ></span>
        </div>
      </div>
    </div>
    <script>
      function handleTickInit(tick) {
        // start interval (default is 1 second) and update clock with current time
        Tick.helper.interval(function () {
          var d = Tick.helper.date();
          tick.value = {
            sep: ".",
            hours: d.getHours() < 10 ? "0" + d.getHours():d.getHours(),
            minutes: d.getMinutes() < 10 ? "0" + d.getMinutes():d.getMinutes(),
            seconds: d.getSeconds() < 10 ? "0" + d.getSeconds():d.getSeconds(),
          };
        });
      }
    </script>

    <script>
      var lastTime = new Date(0);
      var loader = new Image();
    
      
      function changeTime() {
        var now = new Date();
        if (now.getHours() != lastTime.getHours()) {
          fetch("/birdNum?num=" + now.getHours()) // Call the fetch function passing the url of the API as a parameter
            .then(function (response) {
              response.text().then(function (text) {
                try {
                  var bj = JSON.parse(text);
                  placeBird("hours", bj);
                } catch (e) {}
              });
            })
            .catch(function () {});
        }
        if (now.getMinutes() != lastTime.getMinutes()) {
          fetch("/birdNum?num=" + now.getMinutes()) // Call the fetch function passing the url of the API as a parameter
            .then(function (response) {
              response.text().then(function (text) {
                try {
                  var bj = JSON.parse(text);
                  placeBird("mins", bj);
                  
                } catch (e) {}
              });
            })
            .catch(function () {});
        }
        if (now.getSeconds() != lastTime.getSeconds()) {
          //current
          fetch("/birdNum?num=" + now.getSeconds()) // Call the fetch function passing the url of the API as a parameter
            .then(function (response) {
              response.text().then(function (text) {
                try {
                  var bj = JSON.parse(text);
                  placeBird("secs", bj);

                } catch (e) {}
              });
            })
            .catch(function () {});
          //next
          let ni = ((now.getSeconds() + 2) % 60);
          console.log("PRELOAD " + ni);
           fetch("/birdNum?num=" + ni) // Call the fetch function passing the url of the API as a parameter
            .then(function (response) {
              response.text().then(function (text) {
                try {
                  var bj = JSON.parse(text);
                  //placeBird("secs", bj);
                  loader.src = bj.image;

                } catch (e) {}
              });
            })
            .catch(function () {});
        }
        lastTime = now;
      }
      
      function placeBird(section, bird) {
      
            document
              .querySelector("#" + section)
              .querySelector(".tick-flip-panel-front")
              .setAttribute(
                  "style",
                  "background-image: url('" + bird.image + "')"
                );

            var b = document
              .querySelector("#" + section)
              .querySelectorAll(".tick-flip-back")[1];
         

            const newDiv = document.createElement("div");
            
            newDiv.classList.add("species");
            newDiv.innerHTML = bird.comName;
    
            b.innerHTML = "";
            b.appendChild(newDiv);
      }

      setInterval(changeTime, 1000);
    </script>
  </body>
</html>
