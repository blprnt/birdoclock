<!-- This is a static file -->
<!-- served from your routes in server.js -->

<!DOCTYPE html>
<html>
  <head>
    <title>It's Bird O'Clock!</title>
    <meta name="description" content="p5.js CDN Template" />
    <link
      href="https://unpkg.com/@pqina/flip/dist/flip.min.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/@pqina/flip/dist/flip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.3.0/lib/p5.js"></script>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;500&display=swap');
    </style>
    <!--script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.0/addons/p5.dom.js"></script-->
    <!--script src="/sketch.js"></script-->
  </head>
  <body>
    <style>
      .tick {
        font-size: 1rem;
        font-family: Outfit, arial, sans-serif;
        margin: 10em;
      }

      .tick-flip,
      .tick-text-inline {
        font-size: 2.5em;
      }

      .tick-flip-spacer {
      }
      .tick-label {
        margin-top: 1em;
        font-size: 1em;
      }

      .tick-char {
        width: 1.5em;
      }

      .tick-text-inline {
        display: inline-block;
        min-width: 1em;
      }

      .tick-text-inline + .tick-text-inline {
      }

      .tick-group {
      }

      body {
        background-color: rgb(255, 255, 255) !important;
      }

      .tick-text-inline {
        color: rgb(90, 93, 99) !important;
      }

      .tick-label {
        color: rgb(90, 93, 99) !important;
      }

      .tick-flip-panel {
        color: rgb(255, 255, 255) !important;
      }

      .tick-flip {
        font-family: !important;
        text-align: left !important;
      }

      .tick-flip-panel-text-wrapper {
        line-height: 1.5 !important;
        text-align: left;
        font-size: 0.5em;
        margin-top: 1.7em;
        letter-spacing: 0em;
        margin-left: -0.5em;
      }

      .tick-flip-panel {
        background-color: rgb(159, 61, 59) !important;
      }

      .tick-flip-panel-front {
        background-size: cover;
        border-width: 12px 12px 20px 12px;
        border-color:white;
        border-style:solid;
      }

      .tick-flip {
        
        border-radius: 0em !important;
        height: 3em;
      }

      .infoBox {
        position: absolute;
        display: block;
        left: 0px;
        width: 100%;
        height: 100%;
        margin-top:0.1em;
        margin-left:0.1em;
        margin-right:0.2em;
        
      }

      .species {
        position: relative;
        display: block;
        height: auto;
        left: 0px;
        width:100%;
        
        white-space: normal;
        text-indent:0px;
        
        font-size: 0.2em !important;
        letter-spacing: 0em !important;
        color: white;
        
        
        z-index:2;
      }
      
      .latin {
        position: relative;
        display: block;
        height: 100%;
        top: 0em;
        left: 0px;
        width:100%;
  
        white-space: normal;
        text-indent:0px;
        
        font-size: 0.15em !important;
        letter-spacing: 0em !important;
        color: #FFFFFF88;  
        
        z-index:2;
      }

      .since {
        position: absolute;
        display: block;
        height: 0.25em;
        width: auto;
        bottom: 3em;
        font-size: 0.1em !important;
        letter-spacing: 0em !important;
        color: white;
        z-index:2;
        
        font-weight:300;
        
        text-indent:0px;
      }
      
      .mapBox {
        position:absolute;
        display:block;
        left:0px;
        top:100%;
        width:100%;
        height:100%;
        z-index:1;
      }
      
      .mapSvg {
        position:relative;
        display:block;
        left:0px;
        top:-105%;
        display:block;
        width:100%;
        height:100%;
      }
    </style>

    <div class="tick" data-did-init="handleTickInit">
      <div data-layout="horizontal fit">
        <span id="hours" data-key="hours" data-view="flip"></span>

        <span id="mins" data-key="minutes" data-view="flip"></span>

        <div class="secs">
          <span id="secs" data-key="seconds" data-view="flip"></span>
        </div>
      </div>
    </div>
    <script>
      function handleTickInit(tick) {
        // start interval (default is 1 second) and update clock with current time
        Tick.helper.interval(function () {
          changeTime();
          var d = Tick.helper.date();
          tick.value = {
            sep: ".",
            hours: d.getHours() < 10 ? "0" + d.getHours() : d.getHours(),
            minutes:
              d.getMinutes() < 10 ? "0" + d.getMinutes() : d.getMinutes(),
            seconds:
              d.getSeconds() < 10 ? "0" + d.getSeconds() : d.getSeconds(),
          };
        });
      }

      var lastTime = new Date(0);
      var loader = new Image();

      function changeTime() {
        var now = new Date();
        if (now.getHours() != lastTime.getHours()) {
          fetch("/birdNum?num=" + now.getHours()) // Call the fetch function passing the url of the API as a parameter
            .then(function (response) {
              response.text().then(function (text) {
                try {
                  var bj = JSON.parse(text);
                  placeBird("hours", bj);
                } catch (e) {}
              });
            })
            .catch(function () {});
        }
        if (now.getMinutes() != lastTime.getMinutes()) {
          fetch("/birdNum?num=" + now.getMinutes()) // Call the fetch function passing the url of the API as a parameter
            .then(function (response) {
              response.text().then(function (text) {
                try {
                  var bj = JSON.parse(text);
                  placeBird("mins", bj);
                } catch (e) {}
              });
            })
            .catch(function () {});
        }
        if (now.getSeconds() != lastTime.getSeconds()) {
          //current
          fetch("/birdNum?num=" + now.getSeconds()) // Call the fetch function passing the url of the API as a parameter
            .then(function (response) {
              response.text().then(function (text) {
                try {
                  var bj = JSON.parse(text);
                  placeBird("secs", bj);
                } catch (e) {}
              });
            })
            .catch(function () {});
          //next
          let ni = (now.getSeconds() + 5) % 60;
          console.log("PRELOAD " + ni);
          fetch("/birdNum?num=" + ni) // Call the fetch function passing the url of the API as a parameter
            .then(function (response) {
              response.text().then(function (text) {
                try {
                  var bj = JSON.parse(text);
                  //placeBird("secs", bj);
                  loader.src = bj.image;
                  console.log("PRELOAD:" + bj.image);
                } catch (e) {}
              });
            })
            .catch(function () {});
        }
        lastTime = now;
      }

      function placeBird(section, bird) {
        document
          .querySelector("#" + section)
          .querySelector(".tick-flip-panel-front")
          .setAttribute("style", "background-image: url('" + bird.image + "')");

        var b = document
          .querySelector("#" + section)
          .querySelectorAll(".tick-flip-back")[1];

        b.innerHTML = "";

        const infoBox = document.createElement("div");
        infoBox.classList.add("infoBox");

        b.appendChild(infoBox);

        const newDiv = document.createElement("div");

        newDiv.classList.add("species");
        newDiv.innerHTML = bird.comName;
        infoBox.appendChild(newDiv);
        
        const latinDiv = document.createElement("div");

        latinDiv.classList.add("latin");
        latinDiv.innerHTML = bird.sciName;
        infoBox.appendChild(latinDiv);

        const now = new Date();
        let dt = bird.obsDt.replaceAll(" ", "T");
        const then = new Date(dt);

        //how many hours ago?
        const since = now.getTime() - then.getTime();
        const sinceHours = Math.round(since / (1000 * 60 * 60)) + 5;
        
        const colors = ["#26AE25","#009E5A","#008A77","#00757F","#005E73","#2F4858"]

        let sinceMsg = sinceHours == 0 ? "Just now" : sinceHours + " hours ago";
        let ci = Math.ceil(Math.min(Math.pow(sinceHours, 0.4), colors.length - 1));
        b.setAttribute("style", "background-color:" + colors[ci] + " !important;");
        const sinceDiv = document.createElement("div");
        sinceDiv.classList.add("since");
        sinceDiv.innerHTML = sinceMsg;

        infoBox.appendChild(sinceDiv);

        //map
        //<svg id="my_dataviz" width="400" height="300">
        const mapBox = document.createElement("div");
        mapBox.classList.add("mapBox");
        
        const mapDiv = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        
        infoBox.appendChild(mapBox);
        mapBox.appendChild(mapDiv);
        mapDiv.id = bird.subId;
        mapDiv.classList.add("mapSvg")
        
        //think this will redraw maps
        var svg = d3.select("#" + bird.subId);
        
        var width = 270;
        var height = 300;
        
        // Map and projection. Try:  d3.geoAiry() / d3.geoAitoff() / d3.geoArmadillo() / d3.geoAugust() / d3.geoAzimuthalEqualArea() / d3.geoAzimuthalEquidistant() and more
        var projection = d3
          .geoAitoff()
          .scale(width / 1.3 / Math.PI)
          .translate([width / 2, height / 2]);
        
        //pointer 
        var markers = [
            {long: bird.lng, lat: bird.lat}
        ]

        // Load external data and boot
        d3.json(
          "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson",
          function (data) {
            // Draw the map
            svg
              .append("g")
              .selectAll("path")
              .data(data.features)
              .enter()
              .append("path")
              .attr("fill", "#00000025")
              .attr("d", d3.geoPath().projection(projection))
              .style("stroke", "none");
            
            svg
              .selectAll("myCircles")
              .data(markers)
              .enter()
              .append("circle")
                .attr("cx", function(d){ return projection([d.long, d.lat])[0] })
                .attr("cy", function(d){ return projection([d.long, d.lat])[1] })
                .attr("r", 5)
                .style("fill", "#FFFFFF99")
                .attr("stroke", "none")
                .attr("stroke-width", 3)
                .attr("fill-opacity", .4)
          }
        );
      }
    </script>
  </body>
</html>
