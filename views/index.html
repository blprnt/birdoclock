<!-- This is a static file -->
<!-- served from your routes in server.js -->

<!DOCTYPE html>
<html>
  <head>
    <title>It's Bird O'Clock!</title>
    <meta name="description" content="p5.js CDN Template" />
    <link
      href="https://unpkg.com/@pqina/flip/dist/flip.min.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/@pqina/flip/dist/flip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.3.0/lib/p5.js"></script>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <!--script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.0/addons/p5.dom.js"></script-->
    <!--script src="/sketch.js"></script-->
  </head>
  <body>
    <style>
      .tick {
        font-size: 1rem;
        font-family: arial, sans-serif;
        margin: 10em;
      }

      .tick-flip,
      .tick-text-inline {
        font-size: 2.5em;
      }

      .tick-flip-spacer {
      }
      .tick-label {
        margin-top: 1em;
        font-size: 1em;
      }

      .tick-char {
        width: 1.5em;
      }

      .tick-text-inline {
        display: inline-block;
        min-width: 1em;
      }

      .tick-text-inline + .tick-text-inline {
      }

      .tick-group {
      }

      body {
        background-color: rgb(255, 255, 255) !important;
      }

      .tick-text-inline {
        color: rgb(90, 93, 99) !important;
      }

      .tick-label {
        color: rgb(90, 93, 99) !important;
      }

      .tick-flip-panel {
        color: rgb(255, 255, 255) !important;
      }

      .tick-flip {
        font-family: !important;
      }

      .tick-flip-panel-text-wrapper {
        line-height: 1.5 !important;
        text-align: left;
        font-size: 0.5em;
        margin-top: 1.7em;
        letter-spacing: 0em;
        margin-left: -0.3em;
      }

      .tick-flip-panel {
        background-color: rgb(159, 61, 59) !important;
      }

      .tick-flip-panel-front {
        background-size: cover;
      }

      .tick-flip {
        border-radius: 0.05em !important;
        height: 3em;
      }

      .infoBox {
        position: absolute;
        display: inline-block;
        left: 0px;
        width: 100%;
        height: 100%;
      }

      .species {
        position: relative;
        display: block;
        height: 100%;
        top: 0.5em;
        white-space: normal;
        font-size: 0.2em !important;
        letter-spacing: 0em !important;
        color: white;
      }

      .since {
        position: relative;
        display: block;
        height: 0.25em;
        width: auto;
        bottom: 2em;
        white-space: normal;
        font-size: 0.1em !important;
        letter-spacing: 0em !important;
        color: white;
      }
      
      .map {
        display:block;
        left:0px;
        top:0px;
        width:400px;
        height:300px;
        border:1px solid green;
        stroke:rgb(0,0,0);
      }
    </style>

    <div class="tick" data-did-init="handleTickInit">
      <div data-layout="horizontal fit">
        <span id="hours" data-key="hours" data-view="flip"></span>

        <span id="mins" data-key="minutes" data-view="flip"></span>

        <div class="secs">
          <span id="secs" data-key="seconds" data-view="flip"></span>
        </div>
      </div>
    </div>
    <script>
      function handleTickInit(tick) {
        // start interval (default is 1 second) and update clock with current time
        Tick.helper.interval(function () {
          changeTime();
          var d = Tick.helper.date();
          tick.value = {
            sep: ".",
            hours: d.getHours() < 10 ? "0" + d.getHours() : d.getHours(),
            minutes:
              d.getMinutes() < 10 ? "0" + d.getMinutes() : d.getMinutes(),
            seconds:
              d.getSeconds() < 10 ? "0" + d.getSeconds() : d.getSeconds(),
          };
        });
      }

      var lastTime = new Date(0);
      var loader = new Image();

      function changeTime() {
        var now = new Date();
        if (now.getHours() != lastTime.getHours()) {
          fetch("/birdNum?num=" + now.getHours()) // Call the fetch function passing the url of the API as a parameter
            .then(function (response) {
              response.text().then(function (text) {
                try {
                  var bj = JSON.parse(text);
                  placeBird("hours", bj);
                } catch (e) {}
              });
            })
            .catch(function () {});
        }
        if (now.getMinutes() != lastTime.getMinutes()) {
          fetch("/birdNum?num=" + now.getMinutes()) // Call the fetch function passing the url of the API as a parameter
            .then(function (response) {
              response.text().then(function (text) {
                try {
                  var bj = JSON.parse(text);
                  placeBird("mins", bj);
                } catch (e) {}
              });
            })
            .catch(function () {});
        }
        if (now.getSeconds() != lastTime.getSeconds()) {
          //current
          fetch("/birdNum?num=" + now.getSeconds()) // Call the fetch function passing the url of the API as a parameter
            .then(function (response) {
              response.text().then(function (text) {
                try {
                  var bj = JSON.parse(text);
                  placeBird("secs", bj);
                } catch (e) {}
              });
            })
            .catch(function () {});
          //next
          let ni = (now.getSeconds() + 5) % 60;
          console.log("PRELOAD " + ni);
          fetch("/birdNum?num=" + ni) // Call the fetch function passing the url of the API as a parameter
            .then(function (response) {
              response.text().then(function (text) {
                try {
                  var bj = JSON.parse(text);
                  //placeBird("secs", bj);
                  loader.src = bj.image;
                  console.log("PRELOAD:" + bj.image);
                } catch (e) {}
              });
            })
            .catch(function () {});
        }
        lastTime = now;
      }

      function placeBird(section, bird) {
        document
          .querySelector("#" + section)
          .querySelector(".tick-flip-panel-front")
          .setAttribute("style", "background-image: url('" + bird.image + "')");

        var b = document
          .querySelector("#" + section)
          .querySelectorAll(".tick-flip-back")[1];

        b.innerHTML = "";

        const infoBox = document.createElement("div");
        infoBox.classList.add("infoBox");

        b.appendChild(infoBox);

        const newDiv = document.createElement("div");

        newDiv.classList.add("species");
        newDiv.innerHTML = bird.comName;
        infoBox.appendChild(newDiv);

        const now = new Date();
        let dt = bird.obsDt.replaceAll(" ", "T");
        const then = new Date(dt);

        //how many hours ago?
        const since = now.getTime() - then.getTime();
        const sinceHours = Math.round(since / (1000 * 60 * 60)) + 5;

        let sinceMsg = sinceHours == 0 ? "Just now" : sinceHours + " hours ago";
        const sinceDiv = document.createElement("div");
        sinceDiv.classList.add("since");
        sinceDiv.innerHTML = sinceMsg;

        infoBox.appendChild(sinceDiv);

        //map
        //<svg id="my_dataviz" width="400" height="300">
        const mapDiv = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        
        infoBox.appendChild(mapDiv);
        mapDiv.id = "map" + bird.comName;
        mapDiv.classList.add("map");
        
        
        //think this will redraw maps
        var svg = d3.select("svg");
        
        var width = 300;
        var height = 300;
        
        console.log(svg);

        // Map and projection. Try:  d3.geoAiry() / d3.geoAitoff() / d3.geoArmadillo() / d3.geoAugust() / d3.geoAzimuthalEqualArea() / d3.geoAzimuthalEquidistant() and more
        var projection = d3
          .geoAitoff()
          .scale(width / 1.3 / Math.PI)
          .translate([width / 2, height / 2]);

        // Load external data and boot
        d3.json(
          "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson",
          function (data) {
            // Draw the map
            svg
              .append("g")
              .selectAll("path")
              .data(data.features)
              .enter()
              .append("path")
              .attr("fill", "#69b3a2")
              .attr("d", d3.geoPath().projection(projection))
              .style("stroke", "#fff");
          }
        );
      }
    </script>
  </body>
</html>
